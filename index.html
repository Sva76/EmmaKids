<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMMA Kids</title>
  <style>
    body{font-family:system-ui;margin:0;background:#f7f7fb;color:#111}
    header{padding:18px 20px;background:white;border-bottom:1px solid #e5e7eb}
    h1{margin:0;font-size:22px}
    main{max-width:1060px;margin:18px auto;padding:0 16px;display:grid;gap:14px}
    .card{background:white;border:1px solid #e5e7eb;border-radius:14px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .toolbar button{
      padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:white;
      font-weight:700;cursor:pointer
    }
    .toolbar button.primary{background:#111;color:white;border-color:#111}
    .toolbar button.danger{background:#fff1f2;border-color:#fecaca;color:#991b1b}
    .toolbar button.mic{border-color:#c7d2fe}
    .toolbar button.mic.on{background:#eef2ff;border-color:#818cf8}
    canvas{width:100%;height:480px;border:1px solid #e5e7eb;border-radius:14px;background:white;touch-action:none}
    .emmaBox{white-space:pre-wrap;background:#f9fafb}
    small{color:#6b7280}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:white;font-size:12px;color:#374151}
    .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <h1>EMMA Kids (MVP)</h1>
    <small>Disegna + aggiungi pezzi + EMMA ascolta e parla (se il browser lo supporta).</small>
  </header>

  <main>
    <div class="row">
      <!-- BOARD -->
      <div class="card">
        <div class="toolbar">
          <button class="primary" id="btnDraw">‚úçÔ∏è Disegna</button>
          <button id="btnClear" class="danger">üßΩ Cancella</button>
          <button id="btnTry">‚ñ∂ Prova con EMMA</button>

          <span style="width:10px;"></span>

          <button id="addBlock">+ Blocco</button>
          <button id="addBall">+ Palla</button>
          <button id="addArrow">+ Freccia</button>
        </div>

        <div class="kpi">
          <span class="pill" id="modePill">Modalit√†: Disegna</span>
          <span class="pill" id="piecesPill">Pezzi: 0</span>
          <span class="pill" id="strokesPill">Tratti: 0</span>
        </div>

        <div style="margin-top:10px;">
          <canvas id="c"></canvas>
        </div>

        <p style="margin-bottom:0;margin-top:10px;">
          <small>
            Suggerimento: aggiungi una freccia come ‚Äúvento‚Äù e una torre con blocchi.
          </small>
        </p>
      </div>

      <!-- EMMA -->
      <div class="card">
        <div class="toolbar" style="justify-content:space-between;align-items:center">
          <b>EMMA</b>
          <button id="btnSpeak" title="Ripeti a voce">üîä Ripeti</button>
        </div>

        <div class="toolbar" style="margin-top:10px;">
          <button id="btnMic" class="mic">üé§ Ascolta</button>
          <button id="btnMicStop" class="mic" disabled>‚èπ Stop</button>
        </div>

        <p style="margin-top:10px;margin-bottom:8px;">
          <small>Se il microfono funziona, EMMA ‚Äúcapisce‚Äù cosa dici e risponde a voce.</small>
        </p>

        <div class="card emmaBox" id="emmaBox">Ciao! Disegna qualcosa üôÇ</div>

        <p style="margin-top:10px;margin-bottom:0;">
          <small id="micStatus">Microfono: non avviato.</small>
        </p>
      </div>
    </div>
  </main>

  <script>
    // ----------------------------
    // CANVAS setup
    // ----------------------------
    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;

    function resize() {
      const rect = canvas.getBoundingClientRect();
      canvas.width  = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      redraw();
    }
    window.addEventListener("resize", resize);

    // ----------------------------
    // STATE
    // ----------------------------
    let mode = "draw"; // draw | move
    let strokes = [];  // array of stroke: [{x,y},...]
    let drawing = false;

    let pieces = []; // {id,type,x,y,w,h,r,dx,dy,dragging}
    let draggingPiece = null;

    let tries = 0;
    let lastEmmaText = "Ciao! Disegna qualcosa üôÇ";
    let childUtterance = ""; // what the child said (transcript)

    // ----------------------------
    // UI helpers
    // ----------------------------
    const modePill = document.getElementById("modePill");
    const piecesPill = document.getElementById("piecesPill");
    const strokesPill = document.getElementById("strokesPill");
    const emmaBox = document.getElementById("emmaBox");

    function updatePills(){
      modePill.textContent = "Modalit√†: " + (mode === "draw" ? "Disegna" : "Sposta");
      piecesPill.textContent = "Pezzi: " + pieces.length;
      strokesPill.textContent = "Tratti: " + strokes.length;
    }

    function setMode(next){
      mode = next;
      updatePills();
      redraw();
    }

    // ----------------------------
    // DRAW
    // ----------------------------
    function drawStrokes() {
      ctx.lineCap="round"; ctx.lineJoin="round";
      ctx.lineWidth=6; ctx.strokeStyle="#111827";
      for (const s of strokes) {
        if (s.length < 2) continue;
        ctx.beginPath();
        ctx.moveTo(s[0].x, s[0].y);
        for (let i=1;i<s.length;i++) ctx.lineTo(s[i].x, s[i].y);
        ctx.stroke();
      }
    }

    function drawPieces() {
      for (const p of pieces) {
        ctx.save();
        if (p.type === "block") {
          ctx.fillStyle = "#111827";
          ctx.globalAlpha = 0.85;
          roundRect(ctx, p.x, p.y, p.w, p.h, 14);
          ctx.fill();
        } else if (p.type === "ball") {
          ctx.fillStyle = "#111827";
          ctx.globalAlpha = 0.85;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        } else if (p.type === "arrow") {
          ctx.globalAlpha = 0.95;
          ctx.strokeStyle = "#ef4444";
          ctx.lineWidth = 6;
          ctx.beginPath();
          ctx.moveTo(p.x, p.y);
          ctx.lineTo(p.x + 120, p.y);
          ctx.stroke();
          ctx.fillStyle = "#ef4444";
          ctx.beginPath();
          ctx.moveTo(p.x + 120, p.y);
          ctx.lineTo(p.x + 98, p.y - 12);
          ctx.lineTo(p.x + 98, p.y + 12);
          ctx.closePath();
          ctx.fill();
        }
        ctx.restore();
      }
    }

    function redraw() {
      const w = canvas.clientWidth, h = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,w,h);

      // hint text
      ctx.save();
      ctx.fillStyle = "rgba(17,24,39,0.35)";
      ctx.font = "14px system-ui";
      ctx.fillText(mode === "draw" ? "Disegna sul foglio" : "Trascina i pezzi", 14, 24);
      ctx.restore();

      drawStrokes();
      drawPieces();
      updatePills();
    }

    function roundRect(ctx, x, y, w, h, r) {
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // ----------------------------
    // HIT TEST (pieces)
    // ----------------------------
    function hitTest(x, y) {
      for (let i = pieces.length - 1; i >= 0; i--) {
        const p = pieces[i];
        if (p.type === "block") {
          if (x >= p.x && x <= p.x + p.w && y >= p.y && y <= p.y + p.h) return p;
        } else if (p.type === "ball") {
          const dx = x - p.x, dy = y - p.y;
          if (Math.sqrt(dx*dx + dy*dy) <= p.r) return p;
        } else if (p.type === "arrow") {
          if (x >= p.x && x <= p.x + 120 && y >= p.y - 18 && y <= p.y + 18) return p;
        }
      }
      return null;
    }

    // ----------------------------
    // POINTER EVENTS
    // ----------------------------
    function pos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.clientX ?? e.touches?.[0]?.clientX) - r.left;
      const y = (e.clientY ?? e.touches?.[0]?.clientY) - r.top;
      return {x,y};
    }

    function down(e){
      const p = pos(e);

      // drag piece if touched
      const hit = hitTest(p.x, p.y);
      if (hit) {
        draggingPiece = hit;
        hit.dragging = true;
        hit.dx = p.x - hit.x;
        hit.dy = p.y - hit.y;
        setMode("move");
        redraw();
        return;
      }

      // draw
      setMode("draw");
      drawing = true;
      strokes.push([p]);
      redraw();
    }

    function move(e){
      const p = pos(e);

      if (draggingPiece && draggingPiece.dragging) {
        draggingPiece.x = p.x - draggingPiece.dx;
        draggingPiece.y = p.y - draggingPiece.dy;
        redraw();
        return;
      }

      if(!drawing) return;
      strokes[strokes.length-1].push(p);
      redraw();
    }

    function up(){
      drawing = false;
      if (draggingPiece) draggingPiece.dragging = false;
      draggingPiece = null;
    }

    canvas.addEventListener("pointerdown", down);
    canvas.addEventListener("pointermove", move);
    canvas.addEventListener("pointerup", up);
    canvas.addEventListener("pointercancel", up);

    // ----------------------------
    // BUTTONS
    // ----------------------------
    document.getElementById("btnDraw").onclick = () => setMode("draw");

    document.getElementById("btnClear").onclick = () => {
      strokes = [];
      pieces = [];
      tries = 0;
      childUtterance = "";
      setEmma("Ok, ripartiamo üôÇ Disegna o aggiungi un pezzo.");
      redraw();
    };

    document.getElementById("addBlock").onclick = () => {
      pieces.push({ id: Date.now()+"b", type:"block", x: 110, y: 120, w: 150, h: 95 });
      setEmma("Ho aggiunto un blocco. Lo puoi trascinare!");
      redraw();
    };
    document.getElementById("addBall").onclick = () => {
      pieces.push({ id: Date.now()+"o", type:"ball", x: 220, y: 260, r: 42 });
      setEmma("Ho aggiunto una palla. Proviamo a farla rotolare?");
      redraw();
    };
    document.getElementById("addArrow").onclick = () => {
      pieces.push({ id: Date.now()+"a", type:"arrow", x: 170, y: 90 });
      setEmma("Ho aggiunto una freccia: pu√≤ essere vento o spinta.");
      redraw();
    };

    // ----------------------------
    // EMMA: speak + listen
    // ----------------------------
    const micBtn = document.getElementById("btnMic");
    const micStopBtn = document.getElementById("btnMicStop");
    const micStatus = document.getElementById("micStatus");
    const speakBtn = document.getElementById("btnSpeak");

    function setEmma(text, speak=true){
      lastEmmaText = text;
      emmaBox.textContent = text;
      if (speak) emmaSpeak(text);
    }

    function emmaSpeak(text){
      try {
        if (!("speechSynthesis" in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "it-IT";
        u.rate = 1.0;
        u.pitch = 1.05;
        window.speechSynthesis.speak(u);
      } catch (e) {}
    }

    speakBtn.onclick = () => emmaSpeak(lastEmmaText);

    // SpeechRecognition (varia per browser)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;
    if (SpeechRecognition) {
      rec = new SpeechRecognition();
      rec.lang = "it-IT";
      rec.interimResults = true;
      rec.continuous = false;

      rec.onstart = () => {
        micStatus.textContent = "Microfono: sto ascoltando‚Ä¶";
        micBtn.classList.add("on");
        micStopBtn.disabled = false;
        micBtn.disabled = true;
      };

      rec.onend = () => {
        micStatus.textContent = "Microfono: fermo.";
        micBtn.classList.remove("on");
        micStopBtn.disabled = true;
        micBtn.disabled = false;
      };

      rec.onerror = (e) => {
        micStatus.textContent = "Microfono: errore (" + (e.error || "unknown") + ").";
      };

      rec.onresult = (event) => {
        let transcript = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        childUtterance = transcript.trim();
        // feedback immediato non giudicante
        if (childUtterance.length > 0) {
          emmaBox.textContent = "Ho capito: ‚Äú" + childUtterance + "‚Äù.";
        }
      };

      micBtn.onclick = () => {
        setEmma("Ok, dimmi cosa stai disegnando üôÇ", true);
        try { rec.start(); } catch (e) {}
      };
      micStopBtn.onclick = () => {
        try { rec.stop(); } catch (e) {}
      };
    } else {
      micBtn.disabled = true;
      micStopBtn.disabled = true;
      micStatus.textContent = "Microfono: non supportato in questo browser. Prova Chrome/Edge.";
    }

    // ----------------------------
    // EMMA: "Try" logic (errore controllato)
    // ----------------------------
    document.getElementById("btnTry").onclick = async () => {
      tries++;

      if (strokes.length === 0 && pieces.length === 0) {
        setEmma("Prima disegna o aggiungi un pezzo üôÇ");
        return;
      }

      const blocks = pieces.filter(p => p.type === "block").length;
      const balls  = pieces.filter(p => p.type === "ball").length;
      const arrows = pieces.filter(p => p.type === "arrow").length;

      const mirror = childUtterance
        ? `Tu mi hai detto: ‚Äú${childUtterance}‚Äù.`
        : "Non mi hai parlato: va bene lo stesso.";

      // 1¬∞ tentativo: EMMA sbaglia apposta (gentilmente)
      if (tries === 1) {
        setEmma(`${mirror}\nIo penso che andr√† tutto bene‚Ä¶ proviamo! (potrei sbagliare)`);
        await demoOverlay("stand");
        setEmma("Oops üòÖ non era cos√¨. Cambiamo una cosa sola e riproviamo?");
        return;
      }

      // dal 2¬∞: suggerimento pi√π sensato (semplice)
      let tip = "Cambiamo una cosa sola e vediamo l‚Äôeffetto.";
      if (blocks >= 2 && arrows > 0) tip = "Vedo blocchi e vento: forse cade. Proviamo una base pi√π larga?";
      if (balls > 0 && arrows > 0) tip = "Vedo una palla e una spinta: forse rotola. Proviamo a cambiare la freccia.";
      if (arrows === 0 && blocks > 0) tip = "Hai costruito qualcosa! Vuoi aggiungere una freccia (vento) per vedere cosa succede?";
      setEmma(`${mirror}\n${tip}`);
      await demoOverlay(arrows > 0 ? "fall" : "stand");
    };

    // Overlay "simulazione" (solo feedback visivo, non fisica reale)
    function demoOverlay(mode){
      return new Promise((resolve) => {
        let frame = 0;
        function tick(){
          redraw();

          ctx.save();
          ctx.globalAlpha = 0.9;
          ctx.fillStyle = "rgba(255,255,255,0.75)";
          ctx.fillRect(12, 12, 260, 44);
          ctx.fillStyle = "#111827";
          ctx.font = "16px system-ui";
          ctx.fillText("Simulazione‚Ä¶", 22, 40);
          ctx.restore();

          ctx.save();
          const shake = mode === "fall" ? Math.sin(frame/3)*4 : Math.sin(frame/7)*1;
          ctx.translate(shake, 0);

          ctx.strokeStyle = mode === "fall" ? "#ef4444" : "#10b981";
          ctx.lineWidth = 6;
          ctx.beginPath();
          ctx.moveTo(520, 70);
          ctx.lineTo(640, 70);
          ctx.stroke();
          ctx.fillStyle = mode === "fall" ? "#ef4444" : "#10b981";
          ctx.beginPath();
          ctx.moveTo(640, 70);
          ctx.lineTo(615, 55);
          ctx.lineTo(615, 85);
          ctx.closePath();
          ctx.fill();
          ctx.restore();

          frame++;
          if (frame < 40) requestAnimationFrame(tick);
          else resolve();
        }
        requestAnimationFrame(tick);
      });
    }

    // Start
    setEmma("Ciao! Disegna qualcosa üôÇ", false);
    resize();
    updatePills();
  </script>
</body>
</html>
